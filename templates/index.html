<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«–æ–‡é—œéµå­—å…¨è‡ªå‹•æ¨™è¨»ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 30px; }
        .form-section { margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 1.05em; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; font-family: inherit; transition: border-color 0.3s; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .form-group .api-key-input { font-family: 'Courier New', monospace; }
        .btn { padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .loading { display: none; text-align: center; padding: 20px; color: #667eea; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .records-list { margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 10px; display: none; }
        .records-list.show { display: block; }
        .records-list h3 { color: #667eea; margin-bottom: 20px; font-size: 1.5em; }
        .record-item { background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .record-item h4 { color: #333; margin-bottom: 10px; }
        .record-meta { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .record-abstract { color: #555; font-size: 0.95em; margin-top: 10px; max-height: 100px; overflow-y: auto; background: #f1f1f1; padding: 10px; border-radius: 5px; }
        .record-keywords { background: #e7f3ff; padding: 10px; border-radius: 5px; color: #004085; margin-top: 10px; }
        .export-section { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ è«–æ–‡é—œéµå­—å…¨è‡ªå‹•æ¨™è¨»ç³»çµ±</h1>
            <p>ä¸Šå‚³ PDFï¼Œä¸€éµå®Œæˆæ‘˜è¦æ“·å–èˆ‡ AI é—œéµå­—ç”Ÿæˆ</p>
        </div>

        <div class="content">
            <div id="alert" class="alert"></div>

            <div class="form-section">
                <form id="batchForm">
                    <div class="form-group">
                        <label for="pdf_files">æ­¥é©Ÿä¸€ï¼šé¸æ“‡è¦ä¸Šå‚³çš„å¤šå€‹ PDF æª”æ¡ˆ</label>
                        <input type="file" id="pdf_files" name="pdfs" accept=".pdf" required multiple>
                    </div>
                    <div class="form-group">
                        <label for="apiKey">æ­¥é©ŸäºŒï¼šè¼¸å…¥æ‚¨çš„ GitHub Playground API Key</label>
                        <input type="password" id="apiKey" name="apiKey" class="api-key-input" placeholder="è«‹è¼¸å…¥ API Key" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" id="processBtn"> é–‹å§‹å…¨è‡ªå‹•æ¨™è¨˜</button>
                    </div>
                </form>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å…¨é€Ÿè™•ç†ä¸­ï¼Œè«‹ç¨å€™... é€™å¯èƒ½éœ€è¦æ•¸åˆ†é˜æ™‚é–“ã€‚</p>
            </div>

            <div id="recordsList" class="records-list">
                <h3>âœ… è™•ç†å®Œæˆ (<span id="recordCount">0</span> ç­†)</h3>
                <div id="recordsContainer"></div>
                <div class="export-section">
                    <button type="button" class="btn btn-success" id="exportBtn">ğŸ’¾ åŒ¯å‡ºç‚º CSV æª”æ¡ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const batchForm = document.getElementById('batchForm');
        const loading = document.getElementById('loading');
        const alertBox = document.getElementById('alert');
        const recordsList = document.getElementById('recordsList');
        const recordsContainer = document.getElementById('recordsContainer');
        const recordCount = document.getElementById('recordCount');
        const exportBtn = document.getElementById('exportBtn');
        const processBtn = document.getElementById('processBtn');

        let processedRecords = [];

        batchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const pdfFiles = document.getElementById('pdf_files').files;
            const apiKey = document.getElementById('apiKey').value.trim();

            if (pdfFiles.length === 0) {
                showAlert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ PDF æª”æ¡ˆ', 'error');
                return;
            }
            if (!apiKey) {
                showAlert('è«‹è¼¸å…¥ API Key', 'error');
                return;
            }

            const formData = new FormData();
            for (const file of pdfFiles) {
                formData.append('pdfs', file);
            }
            formData.append('apiKey', apiKey);

            showLoading();
            hideAlert();
            recordsList.classList.remove('show');

            try {
                const response = await fetch('/api/process_batch', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    processedRecords = data.records;
                    updateRecordsList();
                    showAlert('æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œæˆï¼', 'success');
                } else {
                    showAlert('è™•ç†å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showAlert('ç™¼ç”Ÿç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼š' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        exportBtn.addEventListener('click', async () => {
            if (processedRecords.length === 0) {
                showAlert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ records: processedRecords })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    const dd = String(now.getDate()).padStart(2, '0');
                    const hh = String(now.getHours()).padStart(2, '0');
                    const min = String(now.getMinutes()).padStart(2, '0');
                    const ss = String(now.getSeconds()).padStart(2, '0');
                    a.href = url;
                    a.download = `è«–æ–‡è³‡æ–™_${yyyy}${mm}${dd}_${hh}${min}${ss}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showAlert('CSV æª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼', 'success');
                } else {
                    const errData = await response.json();
                    showAlert('åŒ¯å‡ºå¤±æ•—: ' + (errData.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            } catch (error) {
                showAlert('åŒ¯å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'error');
            }
        });

        function updateRecordsList() {
            recordCount.textContent = processedRecords.length;
            
            if (processedRecords.length > 0) {
                recordsList.classList.add('show');
                recordsContainer.innerHTML = processedRecords.map((record, index) => `
                    <div class="record-item">
                        <h4>${index + 1}. ${record.title}</h4>
                        <div class="record-meta">
                            ä½œè€…ï¼š${record.author} | å¹´ä»½ï¼š${record.year}
                        </div>
                        <div class="record-abstract">
                            <strong>æ‘˜è¦ï¼š</strong>${record.abstract}
                        </div>
                        <div class="record-keywords">
                            <strong>æ ¸å¿ƒä¸»é¡Œèˆ‡ç›®æ¨™ï¼š</strong>${record.keywords}
                        </div>
                    </div>
                `).join('');
            } else {
                recordsList.classList.remove('show');
            }
        }

        function showLoading() {
            loading.classList.add('show');
            processBtn.disabled = true;
            processBtn.textContent = 'è™•ç†ä¸­...';
        }

        function hideLoading() {
            loading.classList.remove('show');
            processBtn.disabled = false;
            processBtn.textContent = 'ğŸš€ é–‹å§‹å…¨è‡ªå‹•æ¨™è¨˜';
        }

        function showAlert(message, type) {
            alertBox.textContent = message;
            alertBox.className = 'alert show alert-' + type;
        }

        function hideAlert() {
            alertBox.classList.remove('show');
        }
    </script>
</body>
</html>